<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Completo PIX - Frontend + Backend</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .pix-container { background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
        pre { background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; font-size: 12px; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üß™ Teste Completo PIX - Localhost</h1>
    
    <div class="test-section">
        <h2>1. Configura√ß√£o do Teste</h2>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="nome" value="Jo√£o da Silva">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" value="joao@teste.com">
                </div>
                <div class="form-group">
                    <label>CPF:</label>
                    <input type="text" id="cpf" value="12345678901">
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="text" id="telefone" value="11999999999">
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Valor (R$):</label>
                    <input type="number" id="valor" value="50.00" step="0.01" min="5">
                </div>
                <div class="form-group">
                    <label>Produto:</label>
                    <input type="text" id="produto" value="Produto Teste Local">
                </div>
                <div class="form-group">
                    <label>CEP:</label>
                    <input type="text" id="cep" value="01234567">
                </div>
                <div class="form-group">
                    <label>Cidade:</label>
                    <input type="text" id="cidade" value="S√£o Paulo">
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="testarFluxoCompleto()" id="btnTeste">üöÄ Testar Fluxo Completo</button>
            <button onclick="limparTeste()">üßπ Limpar</button>
        </div>
    </div>

    <div id="resultado" class="test-section" style="display: none;">
        <h2>2. Resultado do Teste</h2>
        <div id="resultado-content"></div>
    </div>

    <div id="pix-gerado" class="test-section" style="display: none;">
        <h2>3. PIX Gerado</h2>
        <div id="pix-content"></div>
    </div>

    <div class="test-section">
        <h2>4. Logs Detalhados</h2>
        <pre id="logs">Pronto para testar...\n</pre>
    </div>

    <script>
        let transacaoAtual = null;

        function log(message, type = 'info') {
            const logsEl = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logsEl.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function mostrarResultado(content, type = 'success') {
            const resultadoEl = document.getElementById('resultado');
            const contentEl = document.getElementById('resultado-content');
            
            resultadoEl.style.display = 'block';
            resultadoEl.className = `test-section ${type}`;
            contentEl.innerHTML = content;
        }

        function mostrarPix(data) {
            const pixEl = document.getElementById('pix-gerado');
            const contentEl = document.getElementById('pix-content');
            
            pixEl.style.display = 'block';
            pixEl.className = 'test-section success';
            
            contentEl.innerHTML = `
                <div class="pix-container">
                    <h3>‚úÖ PIX Criado com Sucesso!</h3>
                    <p><strong>ID da Transa√ß√£o:</strong> <code>${data.hash || data.id}</code></p>
                    <p><strong>Valor:</strong> R$ ${(data.amount / 100).toFixed(2)}</p>
                    <p><strong>Status:</strong> ${data.payment_status}</p>
                    
                    <h4>PIX Copia e Cola:</h4>
                    <textarea readonly style="width: 100%; height: 80px; font-family: monospace; font-size: 10px;">${data.pix.pix_url}</textarea>
                    
                    <div style="margin-top: 15px;">
                        <button onclick="verificarPagamento('${data.hash}')">üîç Verificar Pagamento</button>
                        <button onclick="copiarPix('${data.pix.pix_url}')">üìã Copiar PIX</button>
                    </div>
                </div>
                
                <details style="margin-top: 15px;">
                    <summary>Ver Resposta Completa da API</summary>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
        }

        async function testarFluxoCompleto() {
            const btnTeste = document.getElementById('btnTeste');
            btnTeste.disabled = true;
            btnTeste.textContent = '‚è≥ Testando...';

            // Limpar resultados anteriores
            document.getElementById('resultado').style.display = 'none';
            document.getElementById('pix-gerado').style.display = 'none';

            log('üöÄ Iniciando teste completo do fluxo PIX');

            // Etapa 1: Validar dados
            log('1Ô∏è‚É£ Coletando dados do formul√°rio...');
            const dados = {
                debtor_name: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                debtor_document_number: document.getElementById('cpf').value,
                phone: document.getElementById('telefone').value,
                amount: parseFloat(document.getElementById('valor').value),
                produtos: [{
                    nome: document.getElementById('produto').value,
                    preco: parseFloat(document.getElementById('valor').value),
                    quantidade: 1
                }],
                address_street: "Rua Teste",
                address_number: "123",
                address_neighborhood: "Centro",
                address_city: document.getElementById('cidade').value,
                address_state: "SP",
                address_zipcode: document.getElementById('cep').value,
                payment_method: "pix"
            };

            log(`üìã Dados coletados: ${dados.debtor_name}, R$ ${dados.amount}, ${dados.email}`);

            // Etapa 2: Valida√ß√µes
            if (dados.amount < 5) {
                log('‚ùå Valor menor que R$ 5,00 (m√≠nimo da TriboPay)', 'error');
                mostrarResultado('<p>‚ùå <strong>Erro:</strong> Valor deve ser no m√≠nimo R$ 5,00</p>', 'error');
                btnTeste.disabled = false;
                btnTeste.textContent = 'üöÄ Testar Fluxo Completo';
                return;
            }

            if (!dados.email.includes('@')) {
                log('‚ùå Email inv√°lido', 'error');
                mostrarResultado('<p>‚ùå <strong>Erro:</strong> Email inv√°lido</p>', 'error');
                btnTeste.disabled = false;
                btnTeste.textContent = 'üöÄ Testar Fluxo Completo';
                return;
            }

            log('‚úÖ Valida√ß√µes passaram');

            // Etapa 3: Chamar API
            log('2Ô∏è‚É£ Enviando requisi√ß√£o para API...');
            
            try {
                const response = await fetch('/checkout/api.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });

                log(`üì° Resposta recebida - Status: ${response.status} ${response.statusText}`);

                const responseText = await response.text();
                log(`üìÑ Tamanho da resposta: ${responseText.length} caracteres`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }

                // Tentar decodificar JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    log('‚úÖ JSON decodificado com sucesso');
                } catch (parseError) {
                    log('‚ùå Erro ao decodificar JSON: ' + parseError.message, 'error');
                    mostrarResultado(`
                        <h4>‚ùå Resposta Inv√°lida</h4>
                        <p>A API retornou uma resposta que n√£o √© JSON v√°lido.</p>
                        <pre>${responseText}</pre>
                    `, 'error');
                    return;
                }

                // Etapa 4: Processar resposta
                if (data.error === false && data.pix && data.pix.pix_url) {
                    log('‚úÖ PIX gerado com sucesso!', 'success');
                    transacaoAtual = data;
                    mostrarPix(data);
                    mostrarResultado('<h4>‚úÖ Teste Conclu√≠do com Sucesso!</h4><p>PIX gerado e pronto para uso.</p>', 'success');
                } else if (data.success === false) {
                    log('‚ùå API retornou erro: ' + (data.message || 'Erro desconhecido'), 'error');
                    mostrarResultado(`
                        <h4>‚ùå Erro na API</h4>
                        <p><strong>Mensagem:</strong> ${data.message || 'Erro desconhecido'}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                } else {
                    log('‚ö†Ô∏è Resposta inesperada da API', 'warning');
                    mostrarResultado(`
                        <h4>‚ö†Ô∏è Resposta Inesperada</h4>
                        <p>A API retornou uma resposta que n√£o seguiu o padr√£o esperado.</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'warning');
                }

            } catch (error) {
                log('‚ùå Erro na requisi√ß√£o: ' + error.message, 'error');
                mostrarResultado(`
                    <h4>‚ùå Erro de Conex√£o</h4>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <p>Verifique se o servidor Node.js est√° rodando em <code>localhost:3000</code></p>
                `, 'error');
            } finally {
                btnTeste.disabled = false;
                btnTeste.textContent = 'üöÄ Testar Fluxo Completo';
            }
        }

        async function verificarPagamento(transactionHash) {
            if (!transactionHash) {
                log('‚ùå ID da transa√ß√£o n√£o informado', 'error');
                return;
            }

            log(`üîç Verificando status do pagamento: ${transactionHash}`);

            try {
                const response = await fetch(`/checkout/verifica.js?id=${encodeURIComponent(transactionHash)}`);
                const data = await response.json();

                if (data.success) {
                    log(`‚úÖ Status verificado: ${data.status}`, 'success');
                    alert(`Status do pagamento: ${data.status}`);
                } else {
                    log(`‚ùå Erro na verifica√ß√£o: ${data.message}`, 'error');
                    alert(`Erro na verifica√ß√£o: ${data.message}`);
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar pagamento: ${error.message}`, 'error');
                alert(`Erro ao verificar: ${error.message}`);
            }
        }

        function copiarPix(pixCode) {
            navigator.clipboard.writeText(pixCode).then(() => {
                log('üìã PIX copiado para √°rea de transfer√™ncia', 'success');
                alert('PIX copiado para √°rea de transfer√™ncia!');
            }).catch(err => {
                log('‚ùå Erro ao copiar PIX: ' + err.message, 'error');
                alert('Erro ao copiar PIX');
            });
        }

        function limparTeste() {
            document.getElementById('logs').textContent = 'Logs limpos...\n';
            document.getElementById('resultado').style.display = 'none';
            document.getElementById('pix-gerado').style.display = 'none';
            transacaoAtual = null;
            log('üßπ Teste limpo e pronto para novo teste');
        }

        // Log inicial
        log('üìã P√°gina de teste carregada');
        log('üåê Testando em: ' + window.location.origin);
        log('üí° Preencha os dados e clique em "Testar Fluxo Completo"');
    </script>
</body>
</html>