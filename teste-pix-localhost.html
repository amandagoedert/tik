<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PIX Localhost</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Teste PIX Localhost</h1>
    
    <div class="section">
        <h2>Configura√ß√£o do Teste</h2>
        <button onclick="testarAPI()">üöÄ Testar Gera√ß√£o de PIX</button>
        <button onclick="testarConfig()">‚öôÔ∏è Testar Configura√ß√£o</button>
        <button onclick="limparLogs()">üßπ Limpar Logs</button>
    </div>

    <div id="resultado" class="section" style="display: none;">
        <h3>Resultado do Teste</h3>
        <div id="resultado-content"></div>
    </div>

    <div class="section">
        <h3>Logs em Tempo Real</h3>
        <pre id="logs">Clique em "Testar Gera√ß√£o de PIX" para come√ßar...</pre>
    </div>

    <script>
        function log(message) {
            const logsEl = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsEl.textContent += `[${timestamp}] ${message}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function mostrarResultado(content, isError = false) {
            const resultadoEl = document.getElementById('resultado');
            const contentEl = document.getElementById('resultado-content');
            
            resultadoEl.style.display = 'block';
            resultadoEl.className = 'section ' + (isError ? 'error' : 'success');
            contentEl.innerHTML = content;
        }

        async function testarConfig() {
            log('Testando configura√ß√£o...');
            
            try {
                const response = await fetch('/checkout/teste_gateway.js');
                const result = await response.text();
                
                if (response.ok) {
                    log('‚úÖ Configura√ß√£o testada com sucesso');
                    mostrarResultado(`<pre>${result}</pre>`);
                } else {
                    log('‚ùå Erro ao testar configura√ß√£o');
                    mostrarResultado(`<p>Erro HTTP: ${response.status}</p><pre>${result}</pre>`, true);
                }
            } catch (error) {
                log('‚ùå Erro de conex√£o: ' + error.message);
                mostrarResultado(`<p>Erro: ${error.message}</p>`, true);
            }
        }

        async function testarAPI() {
            log('üöÄ Iniciando teste de gera√ß√£o PIX...');
            
            const dadosTeste = {
                debtor_name: "Teste Local",
                email: "teste@localhost.com",
                debtor_document_number: "12345678901",
                phone: "11999999999",
                amount: 50.00,
                produtos: [{
                    nome: "Produto Teste Local",
                    preco: 50.00,
                    quantidade: 1
                }],
                address_street: "Rua Teste",
                address_number: "123",
                address_neighborhood: "Centro",
                address_city: "S√£o Paulo",
                address_state: "SP",
                address_zipcode: "01234567",
                payment_method: "pix"
            };

            log('üì§ Enviando requisi√ß√£o para /checkout/api.js...');
            
            try {
                const response = await fetch('/checkout/api.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosTeste)
                });

                log(`üì• Resposta recebida - Status: ${response.status}`);
                
                const result = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(result);
                        if (data.success && data.pix_url) {
                            log('‚úÖ PIX gerado com sucesso!');
                            mostrarResultado(`
                                <h4>‚úÖ PIX Gerado com Sucesso!</h4>
                                <p><strong>Transaction ID:</strong> ${data.transaction_id || 'N/A'}</p>
                                <p><strong>PIX URL:</strong> <code>${data.pix_url}</code></p>
                                <p><strong>Valor:</strong> R$ ${dadosTeste.amount.toFixed(2)}</p>
                                <details>
                                    <summary>Ver resposta completa</summary>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </details>
                            `);
                        } else {
                            log('‚ùå API retornou erro: ' + (data.message || 'Erro desconhecido'));
                            mostrarResultado(`
                                <h4>‚ùå Erro na API</h4>
                                <p><strong>Mensagem:</strong> ${data.message || 'Erro desconhecido'}</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            `, true);
                        }
                    } catch (parseError) {
                        log('‚ùå Erro ao decodificar JSON da resposta');
                        mostrarResultado(`
                            <h4>‚ùå Resposta Inv√°lida</h4>
                            <p>N√£o foi poss√≠vel decodificar JSON da resposta</p>
                            <pre>${result}</pre>
                        `, true);
                    }
                } else {
                    log('‚ùå Erro HTTP: ' + response.status);
                    mostrarResultado(`
                        <h4>‚ùå Erro HTTP ${response.status}</h4>
                        <pre>${result}</pre>
                    `, true);
                }
            } catch (error) {
                log('‚ùå Erro de conex√£o: ' + error.message);
                mostrarResultado(`
                    <h4>‚ùå Erro de Conex√£o</h4>
                    <p>${error.message}</p>
                    <p>Verifique se o servidor Node.js est√° rodando em <code>localhost:3000</code></p>
                `, true);
            }
        }

        function limparLogs() {
            document.getElementById('logs').textContent = 'Logs limpos...\n';
            document.getElementById('resultado').style.display = 'none';
        }

        // Log inicial
        log('üìã P√°gina de teste carregada');
        log('üåê URL base: ' + window.location.origin);
    </script>
</body>
</html>